---
title: "Extração de dados climáticos do Worldclim"
author: "Prof. Dr. Deoclecio e Dra. Maria Gabriella"
format:
  html:
    toc: true
    toc-location: left
    fig-width: 5
    fig-height: 5
knitr: 
  opts_chunk: 
    fig-align: center
---

```{r}
#| include: false

# Ajuste global para gráficos
library(knitr)
opts_knit$set(global.par = TRUE)
par(mar = c(5, 5, 1, 1))

```

# Introdução

Este relatório Quarto tem como objetivo apresentar um fluxo completo de extração, recorte e análise de dados climáticos globais do [WorldClim](https://www.worldclim.org/), focando na América do Sul.

Os principais passos são:

- Limpeza do ambiente de trabalho;
- Instalação e carregamento de pacotes necessários;
- Download e recorte de dados climáticos globais;
- Reprojeção para o sistema de coordenadas SIRGAS2000 (EPSG:4674);
- Cálculo de médias anuais;
- Exportação dos resultados em formato raster TIFF.

---

# 1. Configuração inicial

```{r pacotes}
# Limpar área de trabalho
rm(list = ls())      
gc(reset = TRUE)     
graphics.off()       

# Pacotes necessários
if(!require(readxl))install.packages("readxl", dep = TRUE)
if(!require(tidyverse))install.packages("tidyverse", dep = TRUE)
if(!require(terra))install.packages("terra", dep = TRUE)
if(!require(geodata))install.packages("geodata", dep = TRUE)
if(!require(geobr))install.packages("geobr", dep = TRUE)
if(!require(sf))install.packages("sf", dep = TRUE)
if(!require(sp))install.packages("sp", dep = TRUE)
if(!require(here))install.packages("here", dep = TRUE)


```

---

# 2. Exemplo: Temperatura média global (tavg)

Neste exemplo, vamos obter os arquivos raster de temperatura média para o mundo, na resolução de 10 minutos. Outras resoluções podem ser facilmente obtidas alterando o argumento `res`. 

O argumento `var` oferece várias opções de variáveis climáticas, conforme a seguir:

- `"tmin"` — Temperatura mínima
- `"tmax"` — Temperatura máxima
- `"tavg"` — Temperatura média
- `"prec"` — Precipitação
- `"wind"` — Velocidade do vento
- `"vapr"` — Pressão de vapor
- `"bio"` — Variáveis bioclimáticas


```{r tavg}
# Baixando temperatura média global com resolução de 10 minutos
tavg_mundo <- geodata::worldclim_global(var = "tavg", res = 10, path = here("worldclim"))
print(class(tavg_mundo))
print(terra::crs(tavg_mundo))

```

No estudo de caso, estamos trabalhando apenas com a América do Sul, portanto, faz sentido utilizarmos apenas um recorte específico.

```{r mascara}
# Definir e aplicar recorte para a América do Sul
ext_america <- terra::ext(-82, -34, -60, 15)
tavg_america <- terra::crop(tavg_mundo, ext_america)

# Visualizar camada de um mês
terra::plot(tavg_america[[1]], main = "Janeiro")
```

Finalmente, recomenda-se corrigir a projeção e realizar as operações geoespaciais com os arquivos raster.


```{r projecao}
# Reprojetar e calcular média
tavg_america_sirgas <- terra::project(tavg_america, "EPSG:4674")
tavg_mean <- terra::app(tavg_america_sirgas, mean)

# Visualizar e salvar resultado
terra::plot(tavg_mean, main = "Temperatura Média Anual")
# Criar a pasta 'raster' na raiz do projeto
if (!dir.exists(here("raster"))) dir.create(here("raster"))

# Salvar o raster dentro da pasta 'raster'
terra::writeRaster(tavg_mean, filename = here("raster", "tavg_mean.tif"), overwrite = TRUE)

```

# 3. Exemplo: Temperatura máxima (tmax)

Aqui, realizamos as mesmas operações para obter a temperatura máxima.


```{r tmax}
tmax_mundo <- geodata::worldclim_global(var = "tmax", res = 10, path = here("worldclim"))
print(class(tmax_mundo))
print(terra::crs(tmax_mundo))

tmax_america <- terra::crop(tmax_mundo, ext_america)
terra::plot(tmax_america[[10]], main = "Temperatura Máxima: Outubro")

tmax_america_sirgas <- terra::project(tmax_america, "EPSG:4674")
tmax_mean <- terra::app(tmax_america_sirgas, mean)
terra::plot(tmax_mean, main = "Temperatura Máxima Anual Média")

#Salvar
terra::writeRaster(tmax_mean, filename = here("raster", "tmax_mean.tif"), overwrite = TRUE)

```
No banco de dados [WorldClim](https://www.worldclim.org/), existem diversas variáveis climáticas disponíveis. Surge, então, a pergunta: **será que existe uma maneira de trabalhar com múltiplas variáveis ao mesmo tempo?**

A seguir, apresenta-se um bloco de código que realiza essa tarefa. Com certeza, existem formas mais elegantes e eficientes de implementar essa rotina, mas isso exigiria um pouco mais de criatividade e imaginação.

---

# 4. Automatizando o processamento de variáveis

```{r extr_auto}

# Lista de variáveis climáticas a processar
vars <- c("tmax", "tmin", "prec")
data_path <- here("worldclim")

# Definir Extent da América do Sul
ext_america <- terra::ext(-82, -34, -60, 15)

# Loop de download e processamento
for (var in vars) {
  climate_data <- tryCatch(
    geodata::worldclim_global(var = var, res = 10, path = data_path),
    error = function(e) {
      message(paste("Erro ao baixar:", var, "->", e$message))
      return(NULL)
    }
  )

  if (is.null(climate_data)) next

  message(paste("Processando:", var))
  
  # Recorte e projeção
  climate_america <- terra::crop(climate_data, ext_america)
  climate_america_sirgas <- terra::project(climate_america, "EPSG:4674")
  
  # Média anual
  climate_mean <- terra::app(climate_america_sirgas, mean)
  terra::plot(climate_mean, main = paste("Média Anual -", var))
  
  # Caminho do arquivo de saída
  output_filename <- here("raster", paste0(var, "_mean.tif"))
  terra::writeRaster(climate_mean, filename = output_filename, overwrite = TRUE)
  
  message(paste("Arquivo salvo em:", output_filename))
}


```
